<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阅读助手</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #2c3e50;
        }
        select, button {
            font-size: 16px;
            padding: 10px;
            margin: 10px 0;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #content, #analysis {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .highlight {
            background-color: yellow;
            cursor: pointer;
        }
        .word-item {
            margin-bottom: 20px;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
        }
        .word {
            font-weight: bold;
            color: #e74c3c;
            font-size: 18px;
            cursor: pointer;
        }
        .explanation {
            margin-left: 20px;
        }
        .example {
            font-style: italic;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <h1>读助手</h1>
    <select id="book-select">
        {% for book in books %}
        <option value="{{ book }}">{{ book }}</option>
        {% endfor %}
    </select>
    <button onclick="readBook()">开始阅读</button>
    <div id="content"></div>
    <div id="analysis"></div>

    <script>
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightDifficultWords(content, difficultWords) {
            let highlightedContent = content;
            let wordPositions = {};

            difficultWords.forEach(word => {
                const escapedWord = escapeRegExp(word.word);
                const regex = new RegExp(`\\b${escapedWord}\\b`, 'gi');
                let match;
                let tempContent = highlightedContent;
                let offset = 0;

                while ((match = regex.exec(tempContent)) !== null) {
                    if (!wordPositions[word.id]) {
                        wordPositions[word.id] = [];
                    }
                    const realPosition = offset + match.index;
                    wordPositions[word.id].push(realPosition);

                    const before = highlightedContent.slice(0, realPosition);
                    const after = highlightedContent.slice(realPosition + match[0].length);
                    const replacement = `<span class="highlight" onclick="scrollToWord('${word.id}')">${match[0]}</span>`;

                    highlightedContent = before + replacement + after;

                    offset = before.length + replacement.length;
                    tempContent = after;
                }
            });

            return { highlightedContent, wordPositions };
        }

        function getTextPosition(html, position) {
            const tempElement = document.createElement('div');
            tempElement.innerHTML = html.slice(0, position);
            return tempElement.textContent.length;
        }

        function updateContent(content, wordCount, difficultWords) {
            const { highlightedContent, wordPositions } = highlightDifficultWords(content, difficultWords);
            document.getElementById('content').innerHTML = `
                <h2>今天的阅读内容 (${wordCount} 词):</h2>
                <p style="white-space: pre-wrap;">${highlightedContent}</p>
            `;
            return wordPositions;
        }

        function updateAnalysis(analysis, wordPositions) {
            if (analysis.error) {
                document.getElementById('analysis').innerHTML = `<p>分析错误: ${analysis.error}</p>`;
                return;
            }
            const analysisHtml = analysis.words.map(word => `
                <div class="word-item" id="${word.id}">
                    <div class="word" onclick="highlightInContent('${word.word}', ${JSON.stringify(wordPositions[word.id])})">${word.word}</div>
                    <div class="explanation">
                        <strong>中文解释:</strong> ${word.chinese_explanation}<br>
                        <strong>英文解释:</strong> ${word.english_explanation}<br>
                        <strong>例句:</strong> <span class="example">${word.example}</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('analysis').innerHTML = `
                <h2>难词分析:</h2>
                ${analysisHtml}
            `;
        }

        function scrollToWord(wordId) {
            const element = document.getElementById(wordId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function highlightInContent(word, positions) {
            const content = document.getElementById('content');
            const contentHtml = content.innerHTML;
            
            // 创建一个临时的div元素来解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentHtml;
            
            // 遍历所有文本节点
            const textNodes = [];
            const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            // 在文本节点中查找和高亮单词
            let totalOffset = 0;
            textNodes.forEach(textNode => {
                const text = textNode.nodeValue;
                const regex = new RegExp(`\\b${escapeRegExp(word)}\\b`, 'gi');
                let match;
                let lastIndex = 0;
                let newHTML = '';
                
                while ((match = regex.exec(text)) !== null) {
                    const matchPosition = totalOffset + match.index;
                    if (positions.includes(matchPosition)) {
                        newHTML += text.slice(lastIndex, match.index);
                        newHTML += `<span style="background-color: #ff9999;">${match[0]}</span>`;
                        lastIndex = regex.lastIndex;
                    }
                }
                
                if (newHTML) {
                    newHTML += text.slice(lastIndex);
                    const newNode = document.createElement('span');
                    newNode.innerHTML = newHTML;
                    textNode.parentNode.replaceChild(newNode, textNode);
                }
                
                totalOffset += text.length;
            });
            
            content.innerHTML = tempDiv.innerHTML;
            
            // 滚动到第一个高亮的单词
            const firstHighlight = content.querySelector('span[style="background-color: #ff9999;"]');
            if (firstHighlight) {
                firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // 2秒后移除高亮
            setTimeout(() => {
                content.querySelectorAll('span[style="background-color: #ff9999;"]').forEach(span => {
                    const parent = span.parentNode;
                    parent.replaceChild(document.createTextNode(span.textContent), span);
                    parent.normalize();
                });
            }, 2000);
        }

        function readBook() {
            const book = document.getElementById('book-select').value;
            axios.post('/read', { book: book }, {
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            })
            .then(function (response) {
                const wordPositions = updateContent(response.data.content, response.data.word_count, response.data.analysis.words);
                updateAnalysis(response.data.analysis, wordPositions);
            })
            .catch(function (error) {
                console.log(error);
            });
        }
    </script>
</body>
</html>
